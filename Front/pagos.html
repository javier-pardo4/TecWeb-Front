<!DOCTYPE html>

<html lang="es">

 

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Pagar con Stripe</title>

    <script src="https://js.stripe.com/v3/"></script> <!-- Incluye la librería de Stripe -->

</head>

 

<body>

    <h1>Pagar con Stripe</h1>

 

    <form id="payment-form">

        <label for="amount">Importe a pagar (EUR):</label>

        <input type="number" step="0.01" id="amount" name="amount" placeholder="0.00" required>

        <button type="button" id="pay-button">Ir al pago</button>

    </form>

 

    <div id="stripe-form" style="display: none;">

        <h2>Procesar Pago</h2>

        <form id="stripe-payment-form">

            <!-- El formulario de Stripe se genera aquí -->

        </form>

    </div>

 

    <script>

        document.getElementById('pay-button').addEventListener('click', async function () {

            // Obtener el importe del formulario

            const amount = parseFloat(document.getElementById('amount').value);

 

            if (isNaN(amount) || amount <= 0) {

                alert('Por favor, introduce un importe válido.');

                return;

            }

 

            // Realizar una solicitud PUT al servidor con el importe

            const url = 'http://localhost:9000/pagos/prepararTransaccion';

            try {

                const response = await fetch(url, {

                    method: 'PUT',

                    headers: {

                        'Content-Type': 'application/json'

                    },

                    body: amount

                });

 

                if (!response.ok) {

                    throw new Error('Error al procesar el pago');

                }

 

                const data = await response;

 

                // Aquí debes recibir los detalles del pago de Stripe desde el servidor (por ejemplo, un clientSecret)

                const clientSecret = await data.text();

                console.log('clientSecret:', clientSecret);

 

                // Inicializar Stripe

                const stripe = Stripe('pk_test_51Q7a2A02ojBChuHytUAVKXrtrahlhQgRGyNNObRq3Je2xrU2j2FBynxvTuFIJBNz7IZLmXpiPxTMzNddmMPobKdt001O4oeQxe');

                const elements = stripe.elements();

 

                const cardElement = elements.create('card');

                cardElement.mount('#stripe-payment-form');

 

                // Mostrar el formulario de Stripe

                document.getElementById('stripe-form').style.display = 'block';

                document.getElementById('payment-form').style.display = 'none';

 

                // Añadir botón de pagar al formulario de Stripe

                const stripePaymentForm = document.getElementById('stripe-payment-form');

                const payButton = document.createElement('button');

                payButton.type = 'submit';

                payButton.textContent = 'Pagar';

                stripePaymentForm.appendChild(payButton);

 

                // Procesar el pago con Stripe

                stripePaymentForm.addEventListener('submit', async function (event) {

                    event.preventDefault();

                    const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {

                        payment_method: {

                            card: cardElement

                        }

                    });

 

                    if (error) {

                        alert('Error en el pago: ' + error.message);

                    } else if (paymentIntent.status === 'succeeded') {

                        alert('Pago exitoso!');

                    }

                });

            } catch (error) {

                console.error('Error:', error);

                alert('Hubo un problema al intentar procesar el pago.');

            }

        });

    </script>

</body>

 

</html>